<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refraction Demo</title>
</head>

<body>
    <div>
        <label for="refractionIndex">Refraction Index:</label>
        <input type="range" id="refractionIndex" min="1.0" max="2.0" step="0.01" value="1.33">
        <span id="refractionValue">1.33</span>
    </div>
    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div>
            <p>Refraction Map</p>
            <canvas id="refractionMap" width="300" height="300" style="border:1px solid #ccc;"></canvas>
        </div>
        <div>
            <p>Image</p>
            <img id="sourceImage" src="https://picsum.photos/300" width="300" height="300" alt="Source"
                style="display:block; border:1px solid #ccc;">
        </div>
        <div>
            <p>Output Image</p>
            <div id="outputContainer" style="position: relative; width: 300px; height: 300px; border: 1px solid #ccc;">
                <img id="outputImage" src="https://picsum.photos/300" width="300" height="300" alt="Output" style="width: 100%; height: 100%; object-fit: cover;">
                <div id="variablurOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; --variablur-filter: blur(10px); --variablur-glass-refraction: 1.33; z-index: 9; --variablur-offset:100%;"></div>
            </div>
        </div>
    </div>
    <script src="../dist/variablur.js"></script>
    <script type="module">

        const refractionCanvas = document.getElementById('refractionMap');
        const refractionCtx = refractionCanvas.getContext('2d');
        const outputContainer = document.getElementById('outputContainer');
        const variablurOverlay = document.getElementById('variablurOverlay');
        const outputImage = document.getElementById('outputImage');
        const sourceImage = document.getElementById('sourceImage');
        const slider = document.getElementById('refractionIndex');
        const valueLabel = document.getElementById('refractionValue');

        function renderRefractionMap(refractionIndex) {
            const width = refractionCanvas.width;
            const height = refractionCanvas.height;
            const radius = 10;
            // calculateRefractionMap now returns ImageData
            const imageData = variablur.calculateRefractionMap(refractionIndex, width, height, radius);
            refractionCtx.putImageData(imageData, 0, 0);
        }

        function renderOutputImage(refractionIndex) {
            // Update the variablur overlay with new refraction value
            variablurOverlay.style.setProperty('--variablur-glass-refraction', refractionIndex);
        }

        function update() {
            const refractionIndex = parseFloat(slider.value);
            renderRefractionMap(refractionIndex);
            renderOutputImage(refractionIndex);
        }

        sourceImage.onload = update;
        slider.addEventListener('input', update);

        if (sourceImage.complete) {
            update();
        }
        slider.addEventListener('input', () => {
            valueLabel.textContent = slider.value;
        });
    </script>
</body>

</html>